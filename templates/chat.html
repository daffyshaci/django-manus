{% extends 'base.html' %} {% block content %}
<div class="row">
  <div class="card pad grow">
    <h2 style="margin-top: 0">Mulai Percakapan Baru</h2>
    <div class="row">
      <div class="grow">
        <label class="muted">Model</label>
        <select class="select" id="model">
          <option value="gpt-4o">gpt-4o</option>
          <option value="gpt-4o-mini">gpt-4o-mini</option>
        </select>
      </div>
    </div>
    <div class="divider"></div>
    <textarea
      class="textarea"
      rows="4"
      placeholder="Tulis pesan pembuka..."
      id="prompt"
    ></textarea>
    <div
      style="display: flex; gap: 12px; margin-top: 12px; align-items: center"
    >
      <button id="btnCreate" class="btn primary">Buat & Mulai</button>
      <span class="muted" id="hint"></span>
    </div>
  </div>
  <div style="width: 360px" class="card pad">
    <div
      style="
        display: flex;
        align-items: center;
        gap: 8px;
        justify-content: space-between;
      "
    >
      <h3 style="margin: 0">Percakapan Saya</h3>
      <button id="btnRefresh" class="btn">Muat Ulang</button>
    </div>
    <div class="divider"></div>
    <div id="conversations" class="muted">Memuat...</div>
  </div>
</div>
{% endblock %} {% block scripts %}
<script>
  const btn = document.getElementById("btnCreate");
  const hint = document.getElementById("hint");
  const conversationsDiv = document.getElementById("conversations");
  const promptEl = document.getElementById("prompt");
  const modelEl = document.getElementById("model");
  const btnRefresh = document.getElementById("btnRefresh");

  async function fetchConversations() {
    conversationsDiv.textContent = "Memuat...";
    try {
      const res = await fetch("/api/v1/chat/conversations", {
        credentials: "include",
      });
      if (!res.ok) throw new Error("Gagal memuat");
      const data = await res.json();
      if (!data || !data.length) {
        conversationsDiv.innerHTML =
          '<div class="muted">Belum ada percakapan.</div>';
        return;
      }
      conversationsDiv.innerHTML = data
        .map(
          (c) => `
      <a class="row card pad" style="margin-bottom:8px" href="/chat/${c.id}/">
        <div class="grow">
          <div><b>${c.title || "(tanpa judul)"}</b></div>
          <div class="muted" style="font-size:12px">Model: ${c.llm_model}</div>
        </div>
        <span class="pill">Buka</span>
      </a>
    `
        )
        .join("");
    } catch (e) {
      conversationsDiv.textContent = "Error memuat daftar";
    }
  }

  btnRefresh.addEventListener("click", fetchConversations);

  btn.addEventListener("click", async () => {
    const prompt = promptEl.value.trim();
    const model = modelEl.value;
    if (!prompt) {
      showToast("Tulis pesan terlebih dahulu");
      return;
    }
    btn.disabled = true;
    btn.textContent = "Membuat...";
    hint.textContent = "";
    try {
      const res = await fetch("/api/v1/chat/conversations", {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
          "X-CSRFToken": getCookie("csrftoken"),
        },
        credentials: "include",
        body: JSON.stringify({ model, content: prompt }),
      });
      if (!res.ok) {
        const err = await res.json().catch(() => ({ error: "Gagal" }));
        throw new Error(err.detail || err.error || "Gagal membuat");
      }
      const conv = await res.json();
      // redirect ke detail
      window.location.href = `/chat/${conv.id}/`;
    } catch (e) {
      hint.textContent = e.message;
      showToast(e.message);
    } finally {
      btn.disabled = false;
      btn.textContent = "Buat & Mulai";
    }
  });

  fetchConversations();
</script>
{% endblock %}
