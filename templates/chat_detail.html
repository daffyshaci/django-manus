{% extends 'base.html' %} {% block content %}
<div class="card pad" id="chatCard">
  <div class="row" style="align-items: center; gap: 8px">
    <div class="pill" id="status">Terhubung</div>
    <div class="muted" id="modelInfo"></div>
    <!-- Agent selector (frontend only) -->
    <span class="pill" id="agentPill">Agent: -</span>
    <select id="agentSelect" class="select" style="max-width:200px">
      <option value="manus">Manus</option>
      <option value="data_analysis">Data Analysis</option>
    </select>
    <span class="muted" style="font-size:12px">(Frontend only)</span>
    <div class="grow"></div>
    <button
      class="btn"
      id="btnClear"
      title="Bersihkan tampilan (tidak hapus di DB)"
    >
      Bersihkan
    </button>
  </div>
  <div class="divider"></div>
  <div
    id="chatLog"
    class="shadow-inset"
    style="
      height: 55vh;
      overflow: auto;
      padding: 12px;
      border-radius: 12px;
      background: #0a0f1a;
      border: 1px solid #1f2937;
    "
  >
    <div class="muted">Memuat percakapan...</div>
  </div>
  <div id="thinking" class="muted" style="display: none; margin-top: 8px">
    ðŸ¤” Agent sedang berpikir...
  </div>
  <div class="divider"></div>
  <div class="row">
    <input id="msg" class="input grow" placeholder="Tulis pesan..." />
    <button id="send" class="btn primary">Kirim</button>
  </div>
  <!-- Image upload UI (frontend only) -->
  <div class="row" style="gap:8px; align-items:center; margin-top:8px">
    <label class="btn" for="imageInput">+ Gambar</label>
    <input id="imageInput" type="file" accept="image/*" multiple style="display:none" />
    <div id="imagePreview" class="row" style="gap:8px; flex-wrap: wrap"></div>
  </div>
</div>
{% endblock %} {% block scripts %}
<script>
  const conversationId = "{{ conversation_id }}";
  const chatLog = document.getElementById("chatLog");
  const sendBtn = document.getElementById("send");
  const msgInput = document.getElementById("msg");
  const statusEl = document.getElementById("status");
  const thinkingEl = document.getElementById("thinking");
  const modelInfo = document.getElementById("modelInfo");
  const btnClear = document.getElementById("btnClear");
  const agentPill = document.getElementById("agentPill");
  const agentSelect = document.getElementById("agentSelect");
  const imageInput = document.getElementById("imageInput");
  const imagePreview = document.getElementById("imagePreview");

  const roleLabel = {
    user: "Anda",
    assistant: "Manus",
    system: "System",
    tool: "Tool",
  };

  // Helpers
  function getQueryParam(name){
    const u = new URL(window.location.href);
    return u.searchParams.get(name);
  }
  function setAgentUI(agent){
    agentPill.textContent = `Agent: ${agent}`;
    if (agentSelect) agentSelect.value = agent;
  }

  // Initialize agent preference (per-conversation)
  (function initAgent(){
    const storageKey = `conv_agent_${conversationId}`;
    let agent = getQueryParam('agent') || localStorage.getItem(storageKey) || localStorage.getItem('preferred_agent_type') || 'manus';
    setAgentUI(agent);
    try { localStorage.setItem(storageKey, agent); } catch (e) {}
    agentSelect.addEventListener('change', () => {
      agent = agentSelect.value;
      setAgentUI(agent);
      try { localStorage.setItem(storageKey, agent); } catch (e) {}
    });
  })();

  // Image upload preview (frontend-only for now)
  const selectedImages = [];
  function renderPreviews(){
    imagePreview.innerHTML = '';
    selectedImages.forEach((item, idx) => {
      const wrap = document.createElement('div');
      wrap.className = 'card';
      wrap.style = 'position:relative; padding:4px;';
      const img = document.createElement('img');
      img.src = item.dataUrl;
      img.style = 'max-width:120px; max-height:90px; display:block; border-radius:6px;';
      const del = document.createElement('button');
      del.textContent = 'Ã—';
      del.className = 'btn';
      del.style = 'position:absolute; top:4px; right:4px; padding:2px 6px;';
      del.addEventListener('click', () => {
        selectedImages.splice(idx,1);
        renderPreviews();
      });
      wrap.appendChild(img);
      wrap.appendChild(del);
      imagePreview.appendChild(wrap);
    });
  }
  imageInput.addEventListener('change', async (e) => {
    const files = Array.from(e.target.files || []);
    for (const file of files){
      if (!file.type.startsWith('image/')) continue;
      const dataUrl = await new Promise((resolve, reject) => {
        const reader = new FileReader();
        reader.onload = () => resolve(reader.result);
        reader.onerror = reject;
        reader.readAsDataURL(file);
      });
      selectedImages.push({ file, dataUrl });
    }
    imageInput.value = '';
    renderPreviews();
  });

  // Indikator typing/streaming sederhana: tampilkan saat ada event thoughts/step dan sembunyikan saat finished
  function setThinking(thinking) {
    thinkingEl.style.display = thinking ? "block" : "none";
  }

  function appendMessage({ role, content, base64_image }) {
    const wrap = document.createElement("div");
    wrap.className = "card pad";
    wrap.style.margin = "8px 0";
    const who = roleLabel[role] || role;
    const header = `<div style="display:flex; gap:8px; align-items:center;"><span class="pill">${who}</span></div>`;
    let bodyHtml = "";
    if (content) {
      // Render markdown
      bodyHtml += `<div style="white-space:pre-wrap; line-height:1.5;">${renderMarkdownToHtml(
        content
      )}</div>`;
    }
    if (base64_image) {
      bodyHtml += `<div style="margin-top:8px"><img style="max-width:100%" src="data:image/png;base64,${base64_image}"/></div>`;
    }
    wrap.innerHTML = header + bodyHtml;
    chatLog.appendChild(wrap);
    chatLog.scrollTop = chatLog.scrollHeight;
  }

  function appendInfo(text) {
    const div = document.createElement("div");
    div.className = "muted";
    div.style.fontSize = "12px";
    div.style.margin = "6px 0";
    div.textContent = text;
    chatLog.appendChild(div);
    chatLog.scrollTop = chatLog.scrollHeight;
  }

  function setSendingState(sending) {
    sendBtn.disabled = sending;
    msgInput.disabled = sending;
    thinkingEl.style.display = sending ? "block" : "none";
  }

  async function loadConversation() {
    const res = await fetch(`/api/v1/chat/conversations/${conversationId}`, {
      credentials: "include",
    });
    if (!res.ok) {
      chatLog.innerHTML = '<div class="muted">Gagal memuat percakapan</div>';
      return;
    }
    const data = await res.json();
    chatLog.innerHTML = "";
    modelInfo.textContent = `Model: ${data.conversation.llm_model}`;
    for (const m of data.messages) {
      appendMessage(m);
    }
    if (data.first_initiate) {
      // Panggil trigger agar Celery mulai memproses pesan pertama
      try {
        await fetch(
          `/api/v1/chat/conversations/${conversationId}/trigger-first-message`,
          {
            method: "POST",
            headers: { "X-CSRFToken": getCookie("csrftoken") },
            credentials: "include",
          }
        );
        appendInfo("Memproses pesan awal...");
      } catch (e) {
        console.warn("trigger-first-message gagal", e);
      }
    }
  }

  async function sendMessage() {
    const text = msgInput.value.trim();
    if (!text && selectedImages.length === 0) {
      showToast('Tulis pesan atau pilih gambar');
      return;
    }
    setSendingState(true);
    try {
      // Optimistic append user message (akan tersimpan via API juga)
      if (text) appendMessage({ role: "user", content: text });
      msgInput.value = "";
      const res = await fetch(
        `/api/v1/chat/conversations/${conversationId}/messages`,
        {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
            "X-CSRFToken": getCookie("csrftoken"),
          },
          credentials: "include",
          body: JSON.stringify({ content: text }), // images belum dikirim ke backend
        }
      );
      if (!res.ok) {
        const err = await res.json().catch(() => ({ error: "Gagal" }));
        throw new Error(err.detail || err.error || "Gagal mengirim pesan");
      }
      appendInfo("Pesan dikirim. Menunggu respons agent...");
    } catch (e) {
      showToast(e.message);
    } finally {
      setSendingState(false);
    }
  }

  sendBtn.addEventListener("click", sendMessage);
  msgInput.addEventListener("keydown", (e) => {
    if (e.key === "Enter" && !e.shiftKey) {
      e.preventDefault();
      sendMessage();
    }
  });
  btnClear.addEventListener("click", () => {
    chatLog.innerHTML = "";
  });

  // WebSocket untuk notifikasi real-time
  let ws;
  function connectWS() {
    const scheme = location.protocol === "https:" ? "wss" : "ws";
    ws = new WebSocket(
      `${scheme}://${location.host}/ws/conversations/${conversationId}/`
    );
    ws.onopen = () => {
      statusEl.textContent = "Terhubung";
      statusEl.style.background = "rgba(16,185,129,0.2)";
      statusEl.style.border = "1px solid rgba(16,185,129,0.4)";
    };
    ws.onclose = () => {
      statusEl.textContent = "Terputus";
      statusEl.style.background = "rgba(239,68,68,0.2)";
      statusEl.style.border = "1px solid rgba(239,68,68,0.4)";
      setTimeout(connectWS, 2000);
    };
    ws.onerror = () => {
      showToast("WS error");
    };
    ws.onmessage = (ev) => {
      try {
        const data = JSON.parse(ev.data);
        if (data.type !== "notify") return;
        handleNotify(data.event, data.payload || {});
      } catch (e) {
        console.warn("Invalid WS data", e);
      }
    };
  }

  function handleNotify(event, payload) {
    switch (event) {
      case "agent.step":
        appendInfo(`Langkah ${payload.step}/${payload.max_steps}`);
        setThinking(true);
        break;
      case "agent.thoughts":
        if (payload.content) appendInfo(`Pemikiran: ${payload.content}`);
        setThinking(true);
        break;
      case "agent.tools_selected":
        appendInfo(`Tools dipilih: ${payload.count}`);
        break;
      case "agent.tools_prepared":
        appendInfo(`Menyiapkan tools: ${(payload.tools || []).join(", ")}`);
        break;
      case "agent.tool_args":
        appendInfo(`Argumen tool: ${payload.arguments}`);
        break;
      case "agent.tool_error":
      case "agent.error":
        showToast(payload.error || payload.detail || "Terjadi kesalahan");
        appendInfo(`Error: ${payload.error || payload.detail}`);
        break;
      case "agent.no_tool":
        appendInfo(
          "Tidak ada tool dipanggil. Memeriksa apakah jawaban sudah final..."
        );
        break;
      case "agent.finished":
        if (payload && payload.tool === "ask_human") {
          appendInfo("Menunggu jawaban pengguna...");
        } else {
          appendInfo("Selesai.");
        }
        setThinking(false);
        break;
      case "agent.cleanup_start":
        appendInfo("Membersihkan resource...");
        break;
      case "agent.cleanup_done":
        appendInfo("Cleanup selesai.");
        break;
      case "message.created":
        if (payload && payload.message) {
          appendMessage(payload.message);
        }
        break;
      default:
        break;
    }
  }

  loadConversation();
  connectWS();
</script>
{% endblock %}
